#!/bin/sh
# chkconfig: 345 85 15
# description: portforwarder service
# processname: portforwarder
# pidfile: /var/run/portforwarder.pid

# Source function library if available (CentOS 6)
if [ -f /etc/init.d/functions ]; then
  . /etc/init.d/functions
fi

NAME=portforwarder
DAEMON_DIR=${DAEMON_DIR:-/opt/portforwarder}
DAEMON=$DAEMON_DIR/portforwarder
PIDFILE=/var/run/portforwarder.pid
LOCKFILE=/var/lock/subsys/portforwarder
SYSCONFIG=/etc/sysconfig/portforwarder

[ -f "$SYSCONFIG" ] && . "$SYSCONFIG"

start() {
  echo -n "Starting $NAME: "
  if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
    echo "$NAME already running"
    return 0
  fi
  cd "$DAEMON_DIR" || exit 1
  nohup "$DAEMON" $DAEMON_ARGS >> "$DAEMON_DIR/$NAME.log" 2>&1 &
  echo $! > "$PIDFILE"
  [ -n "$LOCKFILE" ] && touch "$LOCKFILE"
  echo "started"
}

stop() {
  echo -n "Stopping $NAME: "
  if [ -f "$PIDFILE" ]; then
    kill $(cat "$PIDFILE") 2>/dev/null || true
    sleep 1
    if kill -0 $(cat "$PIDFILE") 2>/dev/null; then
      kill -TERM $(cat "$PIDFILE") 2>/dev/null || true
      sleep 1
    fi
    rm -f "$PIDFILE"
  fi
  [ -n "$LOCKFILE" ] && rm -f "$LOCKFILE"
  echo "stopped"
}

restart() {
  stop
  start
}

status() {
  if [ -f "$PIDFILE" ] && kill -0 $(cat "$PIDFILE") 2>/dev/null; then
    echo "$NAME is running (pid $(cat "$PIDFILE"))"
    exit 0
  fi
  echo "$NAME is stopped"
  exit 3
}

case "$1" in
  start) start ;;
  stop) stop ;;
  restart) restart ;;
  status) status ;;
  *) echo "Usage: $0 {start|stop|restart|status}" ; exit 2 ;;
esac

exit 0
